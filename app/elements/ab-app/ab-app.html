<link rel="import" href="../../components/polymer/polymer.html">

<!-- build:remove -->
<link rel="import" href="../../components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../components/iron-flex-layout/classes/iron-flex-layout.html">
<link rel="import" href="../../components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../components/iron-icons/av-icons.html">
<link rel="import" href="../../components/iron-icons/image-icons.html">
<link rel="import" href="../../components/iron-icons/iron-icons.html">
<link rel="import" href="../../components/iron-pages/iron-pages.html">
<link rel="import" href="../../components/paper-toast/paper-toast.html">

<link rel="import" href="../../components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../components/paper-item/paper-item.html">
<link rel="import" href="../../components/paper-menu/paper-menu.html">
<link rel="import" href="../../components/paper-button/paper-button.html">
<link rel="import" href="../../components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="../../components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../components/paper-input/paper-input.html">


<link rel="import" href="../routing.html">

<link rel="import" href="../ab-menu-item/ab-menu-item.html">
<link rel="import" href="../ab-menu/ab-menu.html">
<link rel="import" href="../ab-player/ab-player.html">
<link rel="import" href="../ab-playlist-header-info/ab-playlist-header-info.html">
<link rel="import" href="../ab-thumblist/ab-thumblist.html">
<link rel="import" href="../ab-tracklist/ab-tracklist.html">
<link rel="import" href="../ez-canvas/ez-canvas.html">


<!-- /build -->

<!-- the following script can help you formatting the dates -->
<script type="text/javascript" src="../../js/utils.js"></script>

<!-- stuff for easel, drawing canvas -->
<script src="easeljs-0.8.1.min.js"></script>
<script src="easeljs-NEXT.combined.js"></script>
<script type="text/javascript" src="../../js/utils.js"></script>

<dom-module id="ab-app">
    <template>

        <!-- build:remove -->

        <style include="shared-styles">
            :host {
                @apply(- -layout-vertical);
                --paper-input-container-color: rgba(255, 255, 255, 0.8);
                --secondary-text-color: rgba(255, 255, 255, 0.8);
                --default-primary-color: #2A2C2B;
                --text-primary-color: rgba(255, 255, 255, 0.8);
                --text-secondary-color: rgba(255, 255, 255, 0.8);
                --primary-text-color: rgba(255, 255, 255, 0.8);
                --paper-menu-background-color: rgba(255, 255, 255, 0.95);
                --primary-background-color: #2A2C2B;
                background-color: rgba(0, 0, 0, 0.1);
           }

            /*Style of the paper-input*/
                paper-input.inputPapers {
                    /* Label and underline color when the input is not focused */
                    --paper-input-container-color: green;
                    /* Label and underline color when the input is focused */
                    --paper-input-container-focus-color: green;
                    /* Label and underline color when the input is invalid */
                    --paper-input-container-invalid-color: green;
                    /* Input foreground color */
                    --paper-input-container-input-color: green;

                    width: 200px;
                }

                paper-input.searchPapers {
                    --paper-input-container-color:red ;
                    --secondary-text-color: red;
                    --default-primary-color: red;
                    --text-primary-color: red;
                    --text-secondary-color: red;
                    --primary-text-color: red;
                    --paper-menu-background-color: red;
                    --primary-background-color: red;
                    background-color: red;
                }

            a:hover {
                text-underline: none;
            }

            #wrapper, #main-content {
                overflow-y: auto;
            }

            #upperBar {
                width: 100%;
                height: 5em;
                margin-top: 3em;

            }

            #btnMiss {
                float: right;
                width: 10em;
                background-color: rgba(0, 0, 0, 0.3);
            }

            #btnHit {
                width: 10em;
                background-color: rgba(0, 0, 0, 0.3);
            }

            .main-nav {
                width: 20vw;
                height: 100vh;
                background: #2A2C2B;
                font-size: 1.3vw;
                transition: width 150ms ease-out;
                overflow-y: auto;
                color: #f7f7f7;
                box-shadow: 0px 0 30px rgba(0, 0, 0, 0.2);
            }

            /* #main-menu-toggle-label {
            cursor: pointer;
            color: rgba(0,0,0,0.4);
            font-size: 32px;
            display: inline-block;
            border: 1px solid rgba(0,0,0,0.4);
            line-height: 0;
            text-align: center;
            border-radius: 4px;
            margin: 0;
            padding: 2px 7px 1px;
            }*/

            /* #main-menu-toggle {
            position: absolute;
            top: -9999px;
            left: -9999px;
            }*/

            /* #main-nav h2 {
            margin: 0;
            padding: 1em;
            color: rgba(0,0,0,0.4);
            font-size: 2em;
            }*/

            /* #main-menu{
            margin-bottom: 60px;
            }*/


            /*
             * In order to not have the liks modify the appearance.
            */
            .inherit {
                color: inherit;
                background-color: inherit;
            }

            .nav-menu {
                line-height: 8.4vh;
            }

            .float-right {
                float: right;
                position: absolute;
                margin-top: 1em;
                right: 1em;
            }

            .max-height {
                max-height: 70vh;
                overflow-y: scroll;
            }

            #search {
                background-color: #2A2C2B;
            }

            .header {
                /*border-bottom: 1px solid rgba(255, 255, 255, 0.3);*/
                box-shadow: 0 0 1px rgba(255, 255, 255, 0.3);
            }

            @media (min-width: 841px) {
                #main-menu-toggle-label, #main-menu-toggle, .mm-user-item .nav-menu {
                    display: none;
                }

                #main-menu-toggle-label, #main-menu-toggle, .mm-user-item {
                    display: none;
                }
            }

            /*
            #create-pl-btn {
            color: rgba(0,0,0,0.4);
            background: rgba(0,0,0,0.1);
            display: inline-block;
            width: auto;
            padding: 2px 5px 4px;
            margin: 0 0
           20px 10px;
            font-size: 1.2em;
            line-height: 1;
            white-space: nowrap;
            overflow: hidden;
            }*/

            /* #create-pl-btn:hover, #create-pl-btn:active {
            background: rgba(0,0,0,0.2);
            color: #f7f7f7;
            text-decoration: none;
            }*/

            /* ab-menu-item{
            outline: none;
            }*/

            /* ab-tracklist{
            font-weight: 500;
            }*/

            /* #mainSearch{
            box-shadow: inset 0 -1px rgba(0,0,0,0.2), inset 0 1px rgba(0,0,0,0.2);
            --paper-input-container-label:{
            color:darkgrey;
            font-size: 1.4em;
            font-weight: inherit;
            };
            --paper-input-container-underline:{
            display:none;
            };
            --paper-input-container-underline-focus:{
            display:none;
            };
            --paper-input-container-input:{
            padding: 0 0 5px 0;
            font-size: 1.4em;
            color: inherit;
            };
            }*/

            /* #mainSearch iron-icon{
            padding: 0 20px 5px;
            }*/

            #boxInputs {
                border: solid;
                width: 300px;
            }

        </style>
        <iron-ajax
                auto
                url="http://localhost:3000/players"
                handle-as="json"
                last-response="{{players}}"
                debounce-duration="300"></iron-ajax>
        <iron-ajax
                auto
                url="http://localhost:3000/games"
                handle-as="json"
                last-response="{{playlists}}"
                debounce-duration="300"></iron-ajax>

        <iron-ajax
                id="newGame"
                url="http://localhost:3000/games"
                handle-as="json"
                content-type="application/json"
                method="POST"
                debounce-duration="3000">
        </iron-ajax>


        <iron-ajax
                auto
                url="http://localhost:3000/players"
                handle-as="json"
                last-response="{{players}}"
                debounce-duration="300"></iron-ajax>

        <paper-header-panel class="flex">
            <paper-toolbar class="header">
                <paper-dropdown-menu label="choose game..." placeholder="{{params.gameid}}">
                    <paper-menu class="dropdown-content">
                        <template is="dom-repeat" items="{{playlists}}" as="playlist">
                            <!--<paper-item><a href="/games/{{playlist._id}}" on-click="_gameItem">{{playlist.date}}</a>-->
                            <!--</paper-item>-->
                            <!--<a href="/games/{{playlist._id}}" on-click="_gameItem">{{playlist.date}}</a>-->
                            <ab-menu-item editable href$="/games/{{playlist._id}}" value="{{playlist._id}}">
                            </ab-menu-item>

                        </template>

                    </paper-menu>
                </paper-dropdown-menu>
                <a href="/createGame" on-click="_newGame" class="inherit"><paper-button>create game</paper-button></a>
                <div class="float-right">
                    <a href="/index" on-click="_redirect" class="inherit"><paper-button >home</paper-button>
                    <a><paper-button on-click="">{{user}}user</paper-button></a>
                    <a><paper-button on-click="">signout</paper-button></a>
                </div>
            </paper-toolbar>

            <!--iron pages for different views-->
            <iron-pages attr-for-selected="data-route" selected="{{route}}">
                <!--main view-->
                <div data-route="main" class="horizontal layout flex" id="wrapper">
                    some info text
                </div>

                <!--game view-->
                <div data-route="games">
                <iron-ajax
                                    id="startGame"
                                    url="http://localhost:3000/games/{{game._id}}"
                                    handle-as="json"
                                    content-type="application/json"
                                    method="PUT"
                                    debounce-duration="3000">
                            </iron-ajax>
                    <iron-ajax
                            auto
                            url="http://localhost:3000/games/{{params.gameid}}"
                            handle-as="json"
                            last-response="{{game}}"
                            debounce-duration="300"></iron-ajax>
                    <!--game is {{params.id}}-->
                    <!--game is {{game._id}}-->
                    <!--iron-pages to change view-->
                    <iron-pages attr-for-selected="state" selected="{{game.state}}">

                        <!--game not started yet-->
                        <div state="0">
                            <div id="boxInputs">
                            Fill the following data
                                <paper-input id="firstname" label="first name"></paper-input>
                                <paper-input id="lastname" label="last name"></paper-input>
                            </div>
                            <paper-button on-click="_createPlayer">create player</paper-button>

                            <iron-ajax
                                    id="startGame"
                                    url="http://localhost:3000/games/{{game._id}}"
                                    handle-as="json"
                                    content-type="application/json"
                                    method="PUT"
                                    debounce-duration="3000">
                            </iron-ajax>

                            <!--FIXME start button changes data but doesn't reload page-->
                            <paper-button on-click="_startGame">start game</paper-button>
                            <div class="float-right max-height">
                                <paper-input id="search" label="player name" class="searchPapers"></paper-input>
                                <paper-listbox>
                                    <template is="dom-repeat" items="{{players}}" as="player">
                                        <paper-item>{{player.number}} | {{player.firstName}} {{player.lastName}}
                                        </paper-item>
                                    </template>
                                </paper-listbox>
                                <!--<ab-tracklist tracks="{{players}}"></ab-tracklist>-->
                            </div>
                        </div>

                        <!--game started-->
                        <div state="1">

                            <!--TODO swap players with game's players (first we have to put players in a game)-->
                            <div class="horizontal layout flex" id="wrapper">

                                <nav class="main-nav-float main-nav">
                                    <paper-listbox on-tap="_activateButtons" id="team1" selectedItem>
                                        <template is="dom-repeat" items="{{players}}" as="player">
                                            <paper-item id="{{player._id}}">{{player.number}} | {{player.firstName}} {{player.lastName}}
                                            </paper-item>
                                        </template>
                                    </paper-listbox>
                                </nav>

                                <div class="content flex" id="main-content">
                                    <div id="upperBar"> 
                                        <paper-button id="btnHit" disabled="true" on-click="_setSuccess">Hit</paper-button>
                                        <paper-button id="btnMiss" disabled="true" on-click="_setFail">Miss</paper-button>
                                         
                                    </div>
                                     
                                    <ez-canvas>
                                    </ez-canvas>
                                </div>
                                <nav class="main-nav-float main-nav">
                                    <paper-listbox>
                                        <template is="dom-repeat" items="{{players}}" as="player">
                                            <paper-item>{{player.number}} | {{player.firstName}} {{player.lastName}}
                                            </paper-item>
                                        </template>
                                    </paper-listbox>
                                </nav>
                            </div>
                        </div>

                        <!--game finished-->
                        <div state="2">

                        </div>

                    </iron-pages>

                <div class="content flex" id="main-content">
                    <div id="upperBar">
                        <paper-button id="btnHit" on-click="_setSuccess">Hit</paper-button>
                        <paper-button id="btnMiss" on-click="_setFail">Miss</paper-button>

                    </div>

                    <ez-canvas>
                    </ez-canvas>

                </div>

            </iron-pages>

        </paper-header-panel>

        <paper-toast id="toast">
            <span class="toast-hide-button" role="button" tabindex="0" onclick="abApp.$.toast.hide()">Ok</span>
        </paper-toast>
        <!-- /build -->
    </template>


    <script>
        (function () {
            'use strict';

            Polymer({
                is: 'ab-app',

                //
                <!-- build:remove -->
                properties: {
                    route: {
                        type: String,
                        notify: true,
                    },
                    params: {
                        type: Object,
                        notify: true
                    },
                    userid: {
                        type: String,
                        value: '563fd9661d1e084ac3e1b6b2'
                    },
                    tracks: {
                        type: Array
                    },
                    albums: {
                        type: Array
                    },
                    artists: {
                        type: Array
                    },
                    playlists: {
                        type: Array
                    },
                    selectedPlaylist: {
                        type: Object
                    }
                },

                _createGame: function (event, detail) {
                    this.$.newGame.body = JSON.stringify({
                        "date": Date.now(),
                        "result": "true",
                    });
                    event.preventDefault()
                    console.log(event.currentTarget.href);
                    this.$.newGame.generateRequest();
                    var resource = event.currentTarget.href.replace(/^http:\/\/localhost:[0-9]{1,4}/,"");
                    page.show(resource)
                },

                _createPlayer: function (event, detail) {
                    this.$.createPlayer.body = JSON.stringify({
                        "firstName": this.$.firstname.value,
                        "lastName": this.$.lastname.value,
                    })
                    this.$.createPlayer.generateRequest();
                },


                _gameItem: function (event, detail) {
                    event.preventDefault();
                    console.log("test")
                },

                _setSuccess: function (event, detail) {
                    console.log("success")
                    if(this.$.team1.selectedItem) {
                        console.log(this.$.team1.selectedItem)

                    }
                    else {
                        console.log("you have to select a player!")
                    }
                },

                _activateButtons: function(event, detail) {
                    this.$.btnHit.disabled = false;
                    this.$.btnMiss.disabled = false;
                },

                _startGame: function (event, detail) {
                    console.log("Starting game!")
                    this.$.startGame.body = JSON.stringify({
                        "state": "1",
                    });
                    event.preventDefault()
                    this.$.startGame.generateRequest();
                    page.show(resource)
                },

                _setFail: function (event, detail) {
                    console.log("fail")
                },

                created: function () {
                    this._hasReceivedAJAXPlaylistsResponse = false;
                },

                _redirect: function(event, detail){
                    event.preventDefault()
                    console.log(event.currentTarget)
                    console.log(event.currentTarget.href)
                    var resource = event.currentTarget.href.replace(/^http:\/\/localhost:[0-9]{1,4}/,"") 
                    page.show(resource)
                },

                ready: function () {
                    window.abApp = this;
                    // window.onload = init;
                },

                // Scroll page to top
                scrollPageToTop: function () {

                },

                _onPlaylistAjax: function (event) {
                    this._hasReceivedAJAXPlaylistsResponse = true;
                },

                // page middleware for playlit
                validatePlaylistId: function (ctx, next, timesTried) {
                    timesTried = timesTried || 0;

                    // try 10 times and then surrender
                    if (timesTried > 9) {
                        return next();
                    }

                    // make sure we have playlists
                    if (!this._hasReceivedAJAXPlaylistsResponse) {
                        return this.async(function () {
                            this.validatePlaylistId(ctx, next, ++timesTried)
                        }, 500)
                    }

                    ctx.playlistExists = false;
                    for (var i = 0, l = this.playlists.length; i < l; i++) {
                        if (this.playlists[i]._id == ctx.params.playlistid) {
                            ctx.playlistExists = true;
                            this.selectedPlaylist = this.playlists[i];
                            break;
                        }
                    }
                    next();
                },

                _calcPlaylistHref(pid)
            {
                return "/playlists/" + pid;
            }
            //
            <!-- /build -->
        });

        })
        ();

    </script>

</dom-module>