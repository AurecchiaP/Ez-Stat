<link rel="import" href="../../components/polymer/polymer.html">

<!-- build:remove -->
<link rel="import" href="../../components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../components/iron-flex-layout/classes/iron-flex-layout.html">
<link rel="import" href="../../components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../components/iron-icons/av-icons.html">
<link rel="import" href="../../components/iron-icons/image-icons.html">
<link rel="import" href="../../components/iron-icons/iron-icons.html">
<link rel="import" href="../../components/iron-pages/iron-pages.html">
<link rel="import" href="../../components/paper-toast/paper-toast.html">
<link rel="import" href="../../components/paper-button/paper-button.html">


<link rel="import" href="../routing.html">

<link rel="import" href="../ab-menu-item/ab-menu-item.html">
<link rel="import" href="../ab-menu/ab-menu.html">
<link rel="import" href="../ab-player/ab-player.html">
<link rel="import" href="../ab-playlist-header-info/ab-playlist-header-info.html">
<link rel="import" href="../ab-thumblist/ab-thumblist.html">
<link rel="import" href="../ab-tracklist/ab-tracklist.html">
<link rel="import" href="../ez-canvas/ez-canvas.html">

<!-- /build -->

<!-- the following script can help you formatting the dates -->
<script type="text/javascript" src="../../js/utils.js"></script>

<!-- stuff for easel, drawing canvas -->
<script src="easeljs-0.8.1.min.js"></script>
<script src="easeljs-NEXT.combined.js"></script>
<script type="text/javascript" src="../../js/utils.js"></script>

<dom-module id="ab-app">
  <template>

    <!-- build:remove -->

    <style>
      :host {
        @apply(--layout-vertical);
      }

      #title{
        font-size: 20px;
      }

      #upperBar{
        width: 100%;
        height: 70px;
      }

      #btnMiss {
        float: right;
      }

      paper-button {
        width: 150px;
        height: 70px;
        background: lightgrey;
      }

      #wrapper, #main-content {
        overflow-y: auto;
      }

      #main-nav {
        width: 20vw;
        height: 100vh;
        background: #2A2C2B;
        font-size: 1.3vw;
        transition: width 150ms ease-out;
        overflow-y: auto;
        color: #f7f7f7;
        box-shadow: 0px 0 30px rgba(0,0,0,0.2);

      }

      .nav-menu{
        line-height: 8.4vh;
      }

      @media(min-width: 841px){
        #main-menu-toggle-label, #main-menu-toggle, .mm-user-item .nav-menu {
          display: none;
        }

        #main-menu-toggle-label, #main-menu-toggle, .mm-user-item {
          display: none;
        }
      }

    </style>
    
    <div class="horizontal layout flex" id="wrapper">

      <nav id="main-nav" class="main-nav-float">
        <iron-ajax
            auto
            url="http://localhost:3000/players"
            handle-as="json"
            last-response="{{players}}"
            debounce-duration="300">
          </iron-ajax>
          <ab-tracklist data-route="library" players="{{players}}">
          </ab-tracklist>
      </nav>
      
    
    
      <!-- Main Content -->
      <ez-canvas></ez-canvas>
      <div id="upperBar">
        <paper-button id="btnHit">Hit</paper-button>
        <span id="title">Choose what the fuck you want!</span>
        <paper-button id="btnMiss">Miss</paper-button>
      </div>
      
    </div>

    <paper-toast id="toast" toggles class="custom x-scope paper-button-0" role="button" animated
        aria-pressed="false" disabled="false" active>
      <span class="toast-hide-button" role="button" tabindex="0" onclick="abApp.$.toast.hide()">Ok</span>
    </paper-toast>
  <!-- /build -->
  </template>

  <script>
    (function () {
      'use strict';

      Polymer({
        is: 'ab-app',

        // <!-- build:remove -->
        properties: {
          route: {
            type: String,
            notify: true,
          },
          params: {
            type: Object,
            notify: true
          },
          userid:{
            type: String,
            value: '563fd9661d1e084ac3e1b6b2'
          },
          tracks:{
            type:Array
          },
          albums:{
            type:Array
          },
          artists:{
            type:Array
          },
          playlists:{
            type: Array
          },
          selectedPlaylist:{
            type:Object
          }
        },

        created: function(){
          this._hasReceivedAJAXPlaylistsResponse = false;
        },

        ready: function() {
          window.abApp = this;
          // window.onload = init;
        },

        // Scroll page to top
        scrollPageToTop: function() {

        },

        _onPlaylistAjax: function(event){
          this._hasReceivedAJAXPlaylistsResponse = true;
        },

        // page middleware for playlit
        validatePlaylistId: function(ctx, next, timesTried){
          timesTried = timesTried || 0;

          // try 10 times and then surrender 
          if(timesTried >9){
            return next();
          }

          // make sure we have playlists
          if(!this._hasReceivedAJAXPlaylistsResponse){
            return this.async(function(){
              this.validatePlaylistId(ctx, next, ++timesTried)
            }, 500)
          }

          ctx.playlistExists = false;
          for(var i = 0, l= this.playlists.length; i<l; i++){
            if(this.playlists[i]._id == ctx.params.playlistid){
              ctx.playlistExists = true;
              this.selectedPlaylist = this.playlists[i];
              break;
            }
          }
          next();
        },

        _calcPlaylistHref(pid){
          return "/playlists/" + pid;
        }
        // <!-- /build -->
      });

    })();

  </script>

</dom-module>
