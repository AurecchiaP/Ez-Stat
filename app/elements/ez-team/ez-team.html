<link rel="import" href="../../components/polymer/polymer.html">

<link rel="import" href="../../components/paper-input/paper-input.html">
<link rel="import" href="../../components/iron-icon/iron-icon.html">
<link rel="import" href="../../components/iron-icons/av-icons.html">
<link rel="import" href="../../components/iron-icons/image-icons.html">

<dom-module id="ez-team">
    <template>

        <style>
            :host {
                display: block;
                -webkit-transition: background 0.3s, box-shadow 0.3s;
                -moz-transition: background 0.3s, box-shadow 0.3s;
                transition: background 0.3s, box-shadow 0.3s;
            }

            :host(:hover) {
                background: rgba(0, 0, 0, 0.2);
                box-shadow: inset 0 -1px rgba(0, 0, 0, 0);
            }

            #textVal {
                padding-left: 1em;
                padding-top: 1.15em;
                display: inline-block;
                outline: none;
                text-decoration: none;
                font-size: 17px;
                color: inherit;
                overflow: hidden;
                white-space: nowrap;
            }

            iron-icon {
                padding: 0 20px;
            }

            #test {
                display: inline-block;
            }

            .editBtn {
                visibility: visible;
                z-index: 10;
                line-height: 1;
                color: rgba(255, 255, 255, 0.4);
            }

            .editBtn:hover {
                color: inherit;
            }

            :host(:hover) .editBtn {
                visibility: visible;
            }

            #editInput {
                display: none;
                line-height: 1;
                padding-left: 12px;
            }
        </style>

        <iron-ajax
                id="setGame"
                url="/games/[[game._id]]"
                handle-as="json"
                content-type="application/json"
                method="PUT"
                on-response="_makeGet"
                debounce-duration="3000">
        </iron-ajax>

        <iron-ajax
                id="createPlayer"
                url="/players"
                handle-as="json"
                content-type="application/json"
                method="POST"
                debounce-duration="3000">
        </iron-ajax>

        <paper-input id="test" label="Team name" on-blur="_loseFocus" value="{{name}}"></paper-input>
        <paper-listbox selectedItem>

            <template is="dom-repeat" items="{{players}}" as="player">
                <paper-item id="{{player._id}}">{{player.firstName}}
                    {{player.lastName}}
                </paper-item>
            </template>
        </paper-listbox>

        <div id="textVal">Player...</div>
        <paper-input id="editInput" placeholder="Player..."></paper-input>
        <paper-icon-button class="editBtn" icon="icons:add" on-tap="_editTapped"></paper-icon-button>
    </template>

    <script>
        (function () {
            'use strict';

            Polymer({
                is: 'ez-team',

                properties: {
                    href: String,
                    team: String,
                    name: String,
                    players: String,
                    icon: String,
                    game: Object
                },

                _loseFocus: function () {
                    var req = {};
                    req[this.team] = this.$.test.value;
                    this.$.setGame.body = JSON.stringify(req);
                    this.$.setGame.generateRequest();
                },

                _editTapped: function (event, detail) {
                    if (event.target.icon == "icons:add") {
                        this.$.textVal.style.display = "none";
                        this.$$('#editInput').style.display = "inline-block";
                        event.target.icon = "icons:save";
                    } else {
                        this._onBlur();
                        event.target.icon = "icons:add";
                    }
                },

                _onBlur: function () {
                    this.$.textVal.style.display = "inline-block";
                    this.$$('#editInput').style.display = "none";
                    var first = this.$.editInput.value.split(" ")[0];
                    var last = this.$.editInput.value.split(" ")[1];
                    if (first && last) {
                        this.$.createPlayer.body = JSON.stringify({
                            "firstName": first,
                            "lastName": last,
                            "team": this.$.test.value
                        });
                        this.$.setGame.body = JSON.stringify({
                            "firstName": first,
                            "lastName": last,
                            "team": this.$.test.value
                        });
                        this.$.createPlayer.generateRequest();
                        this.$.setGame.generateRequest();
                    }

                    else if (isNumber(first) && !last) {
                        this.$.setGame.body = JSON.stringify({
                            "firstName": first,
                            "lastName": "",
                            "team": this.$.test.value
                        });
                        this.$.setGame.generateRequest();
                    }
                },

                _makeGet: function () {
                    var ezApp = document.querySelector("ez-app");
                    ezApp.$.getGame.generateRequest();
                }

            });
            function isNumber(n) {
                return !isNaN(parseFloat(n)) && isFinite(n);
            }
        })();
    </script>

</dom-module>
