<link rel="import" href="../../components/polymer/polymer.html">

<!-- build:remove -->
<link rel="import" href="../../components/iron-menu-behavior/iron-menu-behavior.html">
<script src="easeljs-0.8.1.min.js"></script>
<script src="easeljs-NEXT.combined.js"></script>
<script type="text/javascript" src="../../js/utils.js"></script>
<!-- /build -->

<dom-module id="ez-canvas">
    <template>

        <style>
            :host {
                display: block;

            }

            #myCanvas {
                width: 60vw;
            }

        </style>
        <iron-ajax
                id="shot"
                url="/players/[[selected]]"
                handle-as="json"
                content-type="application/json"
                method="PUT"
                timeout="1000">
        </iron-ajax>


        <iron-ajax
                id="updateScore"
                url="/games/[[gameid]]"
                content-type="application/json"
                handle-as="json"
                method="PUT"
        ></iron-ajax>

        <iron-ajax
                id="getTeam1Score"
                url="/games/[[gameid]]"
                handle-as="json"
                on-response="drawScore"
                last-response="{{team1score}}"
        ></iron-ajax>

        <iron-ajax
                id="getShots"
                auto
                url="/players/[[selected]]"
                handle-as="json"
                on-response="getAllShots"
                last-response="{{shots}}"
        ></iron-ajax>

        <p id="selHit" style="display:none">[[hit]]</p>
        <span>{{team1score}}-{{team2score}}</span>
        <span id="score1" style="display:none">0 </span>
        <span id="score2" style="display:none">0</span>
        <canvas id="myCanvas" width="1500px" height="800px"></canvas>

    </template>

    <script>
        (function () {
            'use strict';

            Polymer({
                is: 'ez-canvas',
                properties: {
                    selected: {
                        type: String,
                        notify: true,
                        observer: "changedPlayer"
                    },
                    hit: {
                        type: String,
                        notify: true
                    },
                    team: {
                        type: String,
                        notify: true,
                        observer: "changedPlayer"
                    },
                    gameid: {
                        type: String,
                        notify: true
                    },
                    team1score: {
                        type: String,
                        notify: true,
                    },
                    team2score: {
                        type: String,
                        notify: true
                    }
                },

                getAllShots: function () {
                    if (this.$.getShots.lastResponse != undefined) {
                        var response = this.$.getShots.lastResponse.shots;
                        for (var shot in response) {
                            drawHitAndMiss(response[shot].success, response[shot].pos_x, response[shot].pos_y);
                        }
                    }
                },

                drawScore: function () {
                    this.team1score = this.$.getTeam1Score.lastResponse.team1score;
                    this.team2score = this.$.getTeam1Score.lastResponse.team2score;
                },

                changedPlayer: function () {
                    window.team = this.team;
                    window.player = this.selected;
                    this.resetShots()
                },


                resetShots: function () {
                    if (window.shotsObj == undefined) {
                        window.shotsObj = {}
                    }
                    for (var players in window.shotsObj) {
                        if (players != window.player) {
                            for (var shot in window.shotsObj[players]) {
                                window.shotsObj[players][shot].visible = false
                                window.stage.update()
                            }
                        }
                        else {
                            for (var shot in window.shotsObj[players]) {
                                window.shotsObj[players][shot].visible = true
                                window.stage.update()
                            }
                        }
                    }
                },


                attached: function () {
                    var score1 = this.$.score1
                    var score2 = this.$.score2
                    var drawCanvScore = this.$.getTeam1Score;
                    var playerHit = this.$.selHit;
                    var ironAjax = this.$.shot;
                    var teamAjax = this.$.updateScore;
                    window.score = this.$.updateScore;

                    var canvas = this.$.myCanvas;
                    var field = measures();
                    if (window.stage == undefined) {
                        window.stage = new createjs.Stage(canvas);
                    }

                    var rect = new createjs.Shape();
                    rect.graphics.setStrokeStyle(2).beginStroke("rgba(0,0,0,1)").drawRect(0, 0, field.width, field.height);
                    // line
                    rect.graphics.setStrokeStyle(2).mt(field.width / 2, 0).lt(field.width / 2, field.height);
                    rect.graphics.setStrokeStyle(2).beginStroke("rgba(0,0,0,1)").arc(field.width / 2, field.height / 2, field.radius, 0, Math.PI * 2);
                    rect.graphics.setStrokeStyle(2).beginStroke("rgba(0,0,0,1)").
                    drawRect(0, field.height / 2 - (field.smallAreaHeight / 2), field.smallAreaWidth, field.smallAreaHeight);
                    rect.graphics.setStrokeStyle(2).beginStroke("rgba(0,0,0,1)").
                    drawRect(field.width - field.smallAreaWidth, field.height / 2 - (field.smallAreaHeight / 2), field.smallAreaWidth, field.smallAreaHeight);
                    rect.graphics.setStrokeStyle(2).beginStroke("rgba(0,0,0,1)").arc(field.smallAreaWidth, field.height / 2, field.radius, Math.PI * 3 / 2, Math.PI / 2);
                    rect.graphics.setStrokeStyle(2).beginStroke("rgba(0,0,0,1)").arc(field.width - field.smallAreaWidth, field.height / 2, field.radius, -Math.PI * 3 / 2, -Math.PI / 2);
                    // left side trey
                    rect.graphics.setStrokeStyle(2).mt(0, field.treyFromBorder).lt(field.treyLength, field.treyFromBorder);
                    rect.graphics.setStrokeStyle(2).mt(0, field.height - field.treyFromBorder).lt(field.treyLength, field.height - field.treyFromBorder);
                    rect.graphics.setStrokeStyle(2).beginStroke("rgba(0,0,0,1)").
                    arc(field.basketFromBorder, field.height / 2, field.treyRadius, Math.PI * 3 / 1.843, Math.PI / 2.688);

                    // right side trey
                    rect.graphics.setStrokeStyle(2).mt(field.width - field.treyLength, field.treyFromBorder).lt(field.width, field.treyFromBorder);
                    rect.graphics.setStrokeStyle(2).mt(field.width - field.treyLength, field.height - field.treyFromBorder).lt(field.width, field.height - field.treyFromBorder);
                    rect.graphics.setStrokeStyle(2).beginStroke("rgba(0,0,0,1)").
                    arc(field.width - field.basketFromBorder, field.height / 2, field.treyRadius, Math.PI - Math.PI / 2.688, Math.PI - Math.PI * 3 / 1.843);

                    var rectangleGraphics = new createjs.Graphics();
                    rectangleGraphics.setStrokeStyle(2).beginFill('rgba(0,0,0,0.1)').beginStroke("rgba(0,0,0,0").mt(0, 0).lt(field.width, 0).lt(field.width, field.height).lt(0, field.height);
                    var rectangleShape = new createjs.Shape(rectangleGraphics);

                    var twoPointsLeft = new createjs.Graphics();
                    twoPointsLeft.setStrokeStyle(2).beginFill('rgba(0,0,0,0.1)').beginStroke("rgba(0,0,0,0)").mt(0, field.treyFromBorder).lt(field.treyLength, field.treyFromBorder).
                    arc(field.basketFromBorder, field.height / 2, field.treyRadius, Math.PI * 3 / 1.843, Math.PI / 2.688).
                    lt(0, field.height - field.treyFromBorder);
                    var twoPointsLeftShape = new createjs.Shape(twoPointsLeft);

                    var twoPointsRight = new createjs.Graphics();
                    twoPointsRight.setStrokeStyle(2).beginFill('rgba(0,0,0,0.1)').beginStroke("rgba(0,0,0,0)").mt(field.width - field.treyLength, field.treyFromBorder).lt(field.width, field.treyFromBorder).
                    lt(field.width, field.height - field.treyFromBorder).
                    arc(field.width - field.basketFromBorder, field.height / 2, field.treyRadius, Math.PI - Math.PI / 2.688, Math.PI - Math.PI * 3 / 1.843);
                    var twoPointsRightShape = new createjs.Shape(twoPointsRight);

                    stage.addChild(rectangleShape);
                    stage.addChild(twoPointsLeftShape);
                    stage.addChild(twoPointsRightShape);
                    stage.addChild(rect);
                    stage.update();


                    rectangleShape.on("click", function (e) {
                        var success = (playerHit.innerHTML == "hit")
                        if (success) {
                            if (window.team == "team1") {
                                var scoreToUpdate = Number(score1.innerHTML)
                                scoreToUpdate += 3
                                score1.innerHTML = scoreToUpdate
                                console.log(scoreToUpdate)
                                teamAjax.body = JSON.stringify({
                                    "team1score": scoreToUpdate
                                });
                                teamAjax.generateRequest();
                                drawCanvScore.generateRequest();
                            }
                            else if (window.team == "team2") {
                                var scoreToUpdate = Number(score2.innerHTML)
                                scoreToUpdate += 3
                                score2.innerHTML = scoreToUpdate
                                teamAjax.body = JSON.stringify({
                                    "team2score": scoreToUpdate
                                });
                                teamAjax.generateRequest();
                                drawCanvScore.generateRequest();

                            }
                            drawHit(e)
                        }
                        else {
                            drawMiss(e)
                        }
                        ironAjax.body = JSON.stringify({
                            "pos_x": String(e.stageX / field.width),
                            "pos_y": String(e.stageY / field.height),
                            "success": success,
                            "two_points": false
                        });
                        ironAjax.generateRequest();
                    });

                    twoPointsLeftShape.on("click", function (e) {
                        var success = (playerHit.innerHTML == "hit")
                        if (success) {
                            if (window.team == "team1") {
                                var scoreToUpdate = Number(score1.innerHTML)
                                scoreToUpdate += 2
                                score1.innerHTML = scoreToUpdate
                                teamAjax.body = JSON.stringify({
                                    "team1score": scoreToUpdate
                                });
                                teamAjax.generateRequest();
                                drawCanvScore.generateRequest();

                            }
                            else if (window.team == "team2") {
                                var scoreToUpdate = Number(score2.innerHTML)
                                scoreToUpdate += 2
                                score2.innerHTML = scoreToUpdate
                                teamAjax.body = JSON.stringify({
                                    "team2score": scoreToUpdate
                                });
                                teamAjax.generateRequest();
                                drawCanvScore.generateRequest();

                            }
                            drawHit(e)
                        }
                        else {
                            drawMiss(e)
                        }
                        ironAjax.body = JSON.stringify({
                            "pos_x": String(e.stageX / field.width),
                            "pos_y": String(e.stageY / field.height),
                            "success": success,
                            "two_points": true
                        });
                        ironAjax.generateRequest();

                    });
                    twoPointsRightShape.on("click", function (e) {
                        var success = (playerHit.innerHTML == "hit")
                        if (success) {
                            if (window.team == "team1") {
                                var scoreToUpdate = Number(score1.innerHTML)
                                scoreToUpdate += 2
                                score1.innerHTML = scoreToUpdate
                                teamAjax.body = JSON.stringify({
                                    "team1score": scoreToUpdate
                                });

                                teamAjax.generateRequest();
                                drawCanvScore.generateRequest();
                            }
                            else if (window.team == "team2") {
                                var scoreToUpdate = Number(score2.innerHTML)
                                scoreToUpdate += 2
                                score2.innerHTML = scoreToUpdate
                                teamAjax.body = JSON.stringify({
                                    "team2score": scoreToUpdate
                                });
                                teamAjax.generateRequest();
                                drawCanvScore.generateRequest();
                            }
                            drawHit(e)
                        }
                        else {
                            drawMiss(e)
                        }
                        ironAjax.body = JSON.stringify({
                            "pos_x": String(e.stageX / field.width),
                            "pos_y": String(e.stageY / field.height),
                            "success": success,
                            "two_points": true
                        });
                        ironAjax.generateRequest();
                    });
                }


            })
            ;
        })();

        function drawHitAndMiss(success, x, y) {
            var field = measures()
            if (success != undefined && x != undefined && y != undefined) {
                x = Number(x) * field.width
                y = Number(y) * field.height
                if (success) {
                    var missGraphics = new createjs.Graphics();
                    missGraphics.setStrokeStyle(2).beginStroke("rgba(0,0,0,1").drawCircle(x, y, 10);
                    var missShape = new createjs.Shape(missGraphics)
                    window.stage.addChild(missShape)
                    window.stage.update()
                    if (window.player != "" && window.shotsObj[player] == undefined) {
                        window.shotsObj[player] = []
                    }
                    window.shotsObj[window.player].push(missShape)
                }
                else {
                    var hitGraphics = new createjs.Graphics();
                    hitGraphics.setStrokeStyle(2).beginStroke("rgba(0,0,0,1").mt(x - 10, y + 10).lt(x + 10, y - 10).mt(x - 10, y - 10).lt(x + 10, y + 10);
                    var hitShape = new createjs.Shape(hitGraphics)
                    window.stage.addChild(hitShape)
                    window.stage.update()
                    if (window.player != "" && window.shotsObj[player] == undefined) {
                        window.shotsObj[player] = []
                    }
                    window.shotsObj[window.player].push(hitShape)

                }
            }
        }

        function updateScore(data) {
            //
        }

        function drawMiss(e) {
            var x = e.stageX;
            var y = e.stageY;
            var hitGraphics = new createjs.Graphics();
            hitGraphics.setStrokeStyle(2).beginStroke("rgba(0,0,0,1").mt(x - 10, y + 10).lt(x + 10, y - 10).mt(x - 10, y - 10).lt(x + 10, y + 10);
            var hitShape = new createjs.Shape(hitGraphics)
            if (window.player != "" && window.shotsObj[player] == undefined) {
                window.shotsObj[player] = []
            }
            window.shotsObj[window.player].push(hitShape)
            stage.addChild(hitShape)
            stage.update()
        }

        function drawHit(e) {
            var x = e.stageX;
            var y = e.stageY;
            var missGraphics = new createjs.Graphics();
            missGraphics.setStrokeStyle(2).beginStroke("rgba(0,0,0,1").drawCircle(x, y, 10);
            var missShape = new createjs.Shape(missGraphics)
            if (window.player != "" && window.shotsObj[player] == undefined) {
                window.shotsObj[player] = []
            }
            window.shotsObj[window.player].push(missShape)
            stage.addChild(missShape)
            stage.update()
        }

        function measures() {
            var width = 1500;
            var ratio = width / 94;
            var field = {
                width: 94 * ratio,
                height: 50 * ratio,
                radius: 6 * ratio,
                smallAreaWidth: 19 * ratio,
                smallAreaHeight: 16 * ratio,
                treyFromBorder: 3 * ratio,
                treyLength: 14 * ratio,
                treyRadius: 23.9 * ratio,
                basketFromBorder: 4.6 * ratio
            };
            return field;
        }

        function updateScore() {
//            window.score.generateRequest()
        }
    </script>



</dom-module>
